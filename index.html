<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark" />
  <title>Euphoria 2026 ‚Äì Neon Awards</title>

  <!--
    Single-file, mobile-first web app.
    Firebase Firestore sync: fill firebaseConfig below.
  -->

  <style>
    :root{
      --bg0:#070812;
      --bg1:#0b0d1f;
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --accent1:#6d4bff;
      --accent2:#00f5ff;
      --accent3:#ff2bd6;
      --good:#33ffb1;
      --warn:#ffd166;
      --bad:#ff4d6d;
      --shadow: 0 18px 50px rgba(0,0,0,.55);
      --radius: 24px;
      --stageW: min(420px, 94vw);
      --safeTop: env(safe-area-inset-top, 0px);
      --safeBot: env(safe-area-inset-bottom, 0px);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(109,75,255,.22), transparent 55%),
        radial-gradient(900px 700px at 80% 20%, rgba(0,245,255,.18), transparent 55%),
        radial-gradient(900px 700px at 50% 90%, rgba(255,43,214,.14), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--txt);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 22px 12px;
      overflow:hidden;
    }

    /* subtle grain */
    body:before{
      content:"";
      position:fixed; inset:-50%;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='120' height='120' filter='url(%23n)' opacity='.12'/%3E%3C/svg%3E");
      opacity:.10;
      pointer-events:none;
      mix-blend-mode:overlay;
      transform: rotate(2deg);
    }

    .stage-wrap{
      width: var(--stageW);
      aspect-ratio: 9 / 16;
      max-height: min(92vh, 860px);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.12);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
      isolation:isolate;
    }

    .desktop-hint{
      position:fixed;
      inset:auto 0 18px 0;
      display:flex;
      justify-content:center;
      pointer-events:none;
      font-size:12px;
      color: rgba(255,255,255,.35);
    }

    .layer{
      position:absolute; inset:0;
      display:flex;
      flex-direction:column;
      padding: calc(16px + var(--safeTop)) 16px calc(16px + var(--safeBot)) 16px;
    }

    .fx-overlay{
      position:absolute; inset:0;
      pointer-events:none;
      opacity:0;
      background:
        radial-gradient(600px 300px at 50% 40%, rgba(255,255,255,.85), transparent 55%),
        linear-gradient(90deg, rgba(0,245,255,.25), rgba(255,43,214,.18), rgba(109,75,255,.20));
      mix-blend-mode:screen;
      z-index:50;
    }
    .fx-overlay.active{ animation: flashGlitch 1.05s ease-out forwards; opacity:1; }
    @keyframes flashGlitch{
      0%{opacity:0; filter: blur(0px) saturate(1); transform: translate3d(0,0,0) scale(1);}
      12%{opacity:1; filter: blur(1px) saturate(1.6); transform: translate3d(0,-2px,0) scale(1.02);}
      38%{opacity:1; transform: translate3d(-3px,0,0) scale(1.03);}
      70%{opacity:.9; filter: blur(2px) contrast(1.2); transform: translate3d(0,0,0) scale(1.03);}
      100%{opacity:0; filter: blur(0px) saturate(1); transform: translate3d(0,0,0) scale(1.0);}
    }

    /* Intro */
    #introLayer{
      z-index:20;
      align-items:center;
      justify-content:center;
      gap: 18px;
      background:
        radial-gradient(700px 500px at 50% 30%, rgba(0,245,255,.16), transparent 60%),
        radial-gradient(700px 500px at 40% 75%, rgba(255,43,214,.14), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.20));
    }
    .scanlines{
      position:absolute; inset:0;
      pointer-events:none;
      background: repeating-linear-gradient(
        180deg,
        rgba(255,255,255,.06) 0px,
        rgba(255,255,255,.02) 2px,
        rgba(0,0,0,0) 6px
      );
      opacity:.22;
      mix-blend-mode: overlay;
      animation: drift 6s linear infinite;
    }
    @keyframes drift{ from{transform: translateY(-20px);} to{transform: translateY(20px);} }

    .intro-title{
      text-align:center;
      letter-spacing: .18em;
      text-transform: uppercase;
      font-weight: 800;
      line-height: 1.05;
      font-size: clamp(28px, 5.8vw, 44px);
      text-shadow:
        0 0 18px rgba(0,245,255,.28),
        0 0 22px rgba(255,43,214,.22),
        0 0 38px rgba(109,75,255,.18);
      padding: 10px 16px;
    }
    .intro-sub{ text-align:center; color: rgba(255,255,255,.75); font-size: 13px; letter-spacing:.08em; }

    .intro-card{
      width: 100%;
      max-width: 340px;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.13);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: 0 12px 40px rgba(0,0,0,.45);
      padding: 14px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .meter{
      height:10px;
      border-radius:999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .meter > i{
      display:block;
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--accent2), var(--accent3), var(--accent1));
      box-shadow: 0 0 18px rgba(0,245,255,.25);
      border-radius:999px;
      animation: fill 10s linear forwards;
    }
    @keyframes fill{to{width:100%}}
    .intro-hint{
      margin-top: 10px;
      display:flex;
      justify-content:space-between;
      gap: 10px;
      font-size: 12px;
      color: rgba(255,255,255,.62);
    }

    /* Main */
    #appLayer{
      z-index:10;
      opacity:0.0;
      pointer-events:none;
      transform: scale(1.01);
      transition: opacity .45s ease, transform .45s ease;
      background:
        radial-gradient(700px 500px at 15% 10%, rgba(109,75,255,.16), transparent 55%),
        radial-gradient(700px 500px at 85% 20%, rgba(0,245,255,.14), transparent 55%),
        radial-gradient(800px 600px at 40% 95%, rgba(255,43,214,.10), transparent 60%);
    }
    #appLayer.active{ opacity:1; pointer-events:auto; transform: scale(1.0); }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 10px;
      border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border-radius: 18px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .brand{display:flex; flex-direction:column; gap:2px; min-width:0;}
    .brand b{
      font-size: 14px;
      letter-spacing:.12em;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand small{ color: rgba(255,255,255,.62); font-size: 11px; letter-spacing:.06em; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      font-size: 12px; color: rgba(255,255,255,.78);
      user-select:none;
    }
    .dot{ width:8px; height:8px; border-radius:999px; background: rgba(255,255,255,.35); }
    .dot.online{ background: var(--good); box-shadow: 0 0 18px rgba(51,255,177,.24); }
    .dot.warn{ background: var(--warn); box-shadow: 0 0 18px rgba(255,209,102,.22); }
    .dot.bad{ background: var(--bad); box-shadow: 0 0 18px rgba(255,77,109,.22); }

    .content{ margin-top: 12px; flex:1; min-height:0; display:flex; flex-direction:column; gap: 12px; }

    .card{
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 10px 38px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .card .hd{
      padding: 12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap: 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .card .hd h2{
      margin:0;
      font-size: 13px;
      letter-spacing:.10em;
      text-transform: uppercase;
      color: rgba(255,255,255,.86);
    }
    .card .bd{padding: 12px 14px;}
    .muted{color: rgba(255,255,255,.68)}

    .btnrow{ display:flex; flex-wrap:wrap; gap: 10px; align-items:center; }
    button, .btn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.20);
      color: rgba(255,255,255,.88);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 700;
      letter-spacing:.02em;
      cursor:pointer;
      transition: transform .12s ease, background .2s ease, border-color .2s ease;
      user-select:none;
      touch-action: manipulation;
    }
    button:hover{ background: rgba(255,255,255,.07); }
    button:active{ transform: scale(.98); }
    .btn.primary{ background: linear-gradient(90deg, rgba(0,245,255,.22), rgba(255,43,214,.18)); border-color: rgba(0,245,255,.22); }
    .btn.ghost{ background: rgba(0,0,0,.10); border-color: rgba(255,255,255,.12); color: rgba(255,255,255,.76); }
    .btn.danger{ background: rgba(255,77,109,.12); border-color: rgba(255,77,109,.25); }
    .btn.small{ padding: 8px 10px; border-radius: 12px; font-size: 12px; }

    .grid{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 10px; }
    .tile{
      position:relative;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: radial-gradient(140px 90px at 30% 20%, rgba(0,245,255,.14), transparent 70%),
                  radial-gradient(140px 90px at 80% 60%, rgba(255,43,214,.12), transparent 70%),
                  rgba(0,0,0,.18);
      padding: 12px;
      overflow:hidden;
      min-height: 96px;
      cursor:pointer;
    }
    .tile:before{
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(120deg, rgba(0,245,255,.10), rgba(255,43,214,.08), rgba(109,75,255,.10));
      filter: blur(10px);
      opacity:.65;
      z-index:0;
    }
    .tile > *{ position:relative; z-index:1; }
    .tile b{ display:block; font-size: 14px; letter-spacing:.02em; margin-bottom: 6px; }
    .tile small{ color: rgba(255,255,255,.62); }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.76);
      display:inline-block;
      margin-top: 8px;
    }

    .list{ display:flex; flex-direction:column; gap: 10px; }
    .item{
      display:flex; align-items:center; gap: 10px;
      padding: 10px 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      cursor:grab;
      user-select:none;
      touch-action:none; /* SortableJS touch drag */
    }
    .item:active{ cursor:grabbing; }
    .handle{
      width: 34px; height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:center;
      color: rgba(255,255,255,.70);
      flex: 0 0 auto;
    }
    .name{
      flex: 1 1 auto; min-width:0;
      font-weight: 700; font-size: 13px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .badge{
      flex: 0 0 auto;
      min-width: 40px;
      text-align:center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(90deg, rgba(0,245,255,.12), rgba(255,43,214,.10));
      font-weight: 900;
      letter-spacing:.02em;
      font-size: 12px;
    }

    .footer{
      display:flex; gap:10px; flex-wrap:wrap;
      justify-content:space-between; align-items:center;
      padding-top: 6px;
      color: rgba(255,255,255,.52);
      font-size: 12px;
    }

    /* modal */
    .modal{
      position:absolute; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      background: rgba(0,0,0,.55);
      z-index:40;
    }
    .modal.show{ display:flex; }
    .modal .panel{
      width:100%;
      max-width: 340px;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 14px;
    }
    label{display:block; font-size:12px; color: rgba(255,255,255,.70); margin-bottom:6px;}
    input{
      width:100%;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.92);
      padding: 11px 12px;
      outline:none;
      font-weight: 700;
    }
    input::placeholder{color: rgba(255,255,255,.45)}
    .row{display:flex; gap:10px;}
    .row > *{flex:1}

    @media (min-width: 980px){
      .stage-wrap{ width: min(980px, 94vw); aspect-ratio: 16 / 9; max-height: min(84vh, 640px); }
      .grid{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    }

    .scroll{ overflow:auto; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; }
  
    /* FIX: allow scrolling fully to last item (no cutoff at bottom) */
    #catsCard, #rankCard{
      display:flex;
      flex-direction:column;
      flex:1;
      min-height:0;
    }
    #catsCard .hd, #rankCard .hd{ flex: 0 0 auto; }
    #catsCard .bd.scroll, #rankCard .bd.scroll{
      flex: 1 1 auto;
      min-height:0;
      padding-bottom: calc(28px + var(--safeBot)); /* extra space so last tile is reachable */
      scroll-padding-bottom: calc(28px + var(--safeBot));
    }

  /* Mobile reorder controls (touch-friendly) */
.mctl{ display:none; margin-left:auto; gap:8px; }
.mctl button{
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: inherit;
  border-radius: 12px;
  width: 40px;
  height: 40px;
  font-size: 18px;
  line-height: 1;
  touch-action: manipulation;
}
.mctl button:active{ transform: scale(.98); }

/* On touch screens: scroll normally, reorder with buttons (no drag) */
@media (pointer: coarse) {
  .item{ touch-action: pan-y; cursor: default; }
  .handle{ display:none; }
  .mctl{ display:flex; }
}

</style>
</head>

<body>
  <div class="stage-wrap" id="stage">
    <div class="fx-overlay" id="fx"></div>

    <!-- INTRO LAYER -->
    <section class="layer" id="introLayer" aria-label="Intro Screen">
      <div class="scanlines"></div>

      <div class="intro-title">Euphoria<br/>2026</div>
      <div class="intro-sub">NEON AWARDS ‚Ä¢ LIVE RANKING</div>

      <div class="intro-card">
        <div class="meter" aria-label="Intro progress"><i id="introMeter"></i></div>
        <div class="intro-hint">
          <span>auto start</span>
          <span id="introCountdown">10.0s</span>
        </div>
      </div>

      <div style="position:absolute; bottom:12px; left:16px; right:16px; text-align:center; color:rgba(255,255,255,.50); font-size:11px; letter-spacing:.08em;">
        Tip: Œ¨ŒΩŒøŒπŒæŒµ œÉŒµ 2 œÉœÖœÉŒ∫ŒµœÖŒ≠œÇ ŒºŒµ ŒØŒ¥ŒπŒø <span class="kbd">?room=</span> Œ≥ŒπŒ± live sync
      </div>
    </section>

    <!-- MAIN APP LAYER -->
    <section class="layer" id="appLayer" aria-label="Main App Screen">
      <div class="topbar">
        <div class="brand">
          <b>Euphoria ‚Äì Neon Awards</b>
          <small>room: <span id="roomIdTxt">‚Ä¶</span> ‚Ä¢ profile: <span id="profileTxt">‚Äî</span></small>
        </div>
        <div class="pill" title="Firestore sync status">
          <span class="dot" id="syncDot"></span>
          <span id="syncTxt">offline</span>
        </div>
      </div>

      <div class="content">
        <!-- Home -->
        <div class="card" id="homeCard">
          <div class="hd">
            <h2>Profiles</h2>
            <div class="btnrow">
              <button class="btn small ghost" id="btnImport" type="button">Import .xlsx</button>
                            <button class="btn small ghost" id="btnTemplate" type="button">‚¨áÔ∏è Template</button>
<button class="btn small ghost" id="btnStats" type="button">üìä Stats</button>
              <button class="btn small danger" id="btnResetAll" type="button">Reset room (local)</button>
            </div>
          </div>
          <div class="bd">
            <div class="grid" id="profilesGrid"></div>
            <div class="footer">
              <span class="muted">Drag & drop ranking ‚Ä¢ auto-save</span>
              <span class="muted">v1 ‚Ä¢ single-file</span>
            </div>
          </div>
        </div>

        <!-- Categories -->
        <div class="card" id="catsCard" style="display:none; flex:1; min-height:0;">
          <div class="hd">
            <h2>Categories</h2>
            <div class="btnrow">
              <button class="btn small ghost" id="btnBackHome" type="button">‚Üê Home</button>
              <button class="btn small danger" id="btnResetProfile" type="button">Reset profile</button>
              <button class="btn small ghost" id="btnImportProfile" type="button">Import Excel</button>
            </div>
          </div>
          <div class="bd scroll" id="catsScroll" style="flex:1; min-height:0;">
            <div class="list" id="catsList"></div>
          </div>
        </div>

        <!-- Ranking -->
        <div class="card" id="rankCard" style="display:none; flex:1; min-height:0;">
          <div class="hd">
            <h2 id="rankTitle">Ranking</h2>
            <div class="btnrow">
              <button class="btn small ghost" id="btnBackCats" type="button">‚Üê Categories</button>
              <button class="btn small danger" id="btnResetCat" type="button">Reset category</button>
            </div>
          </div>
          <div class="bd scroll" id="rankScroll" style="flex:1; min-height:0;">
            <div class="list" id="rankList"></div>
          </div>
          <div class="bd" style="padding-top:0;">
            <div class="footer">
              <span class="muted">Score: 12,10,8,7,6,5,4,3,2,1</span>
              <span class="muted" id="autosaveTxt">saved</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Modals -->
      <!-- Profile code -->
      <div class="modal" id="codeModal" role="dialog" aria-modal="true">
        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px;">
            <b style="letter-spacing:.08em;text-transform:uppercase;font-size:13px;">Enter code</b>
            <button class="btn small ghost" id="codeClose" type="button">‚úï</button>
          </div>
          <div class="muted" style="font-size:12px;margin-bottom:10px;">
            Profile: <b id="codeProfileName">‚Äî</b>
          </div>
          <label for="codeInput">Code</label>
          <input id="codeInput" inputmode="numeric" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="8" />
          <div style="height:10px"></div>
          <div class="row">
            <button class="btn ghost" id="codeCancel" type="button">Cancel</button>
            <button class="btn primary" id="codeOk" type="button">Unlock</button>
          </div>
          <div class="muted" id="codeErr" style="margin-top:10px;font-size:12px;display:none;color:rgba(255,77,109,.9);">
            Wrong code.
          </div>
        </div>
      </div>

      <!-- Excel import -->
      <div class="modal" id="importModal" role="dialog" aria-modal="true">
        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px;">
            <b style="letter-spacing:.08em;text-transform:uppercase;font-size:13px;">Excel Import</b>
            <button class="btn small ghost" id="importClose" type="button">‚úï</button>
          </div>

          <div class="muted" style="font-size:12px;line-height:1.35;margin-bottom:10px;">
            Œ•œÄŒøœÉœÑŒ∑œÅŒØŒ∂ŒøŒΩœÑŒ±Œπ 3 formats:
            <ul style="margin:8px 0 0 18px; padding:0;">
              <li><b>Sheets named</b> œÉŒ±ŒΩ category Œ∫Œ±Œπ items œÉœÑŒ∑ŒΩ Column A</li>
              <li>1 sheet ŒºŒµ columns: <b>Category</b>, <b>Item</b></li><li><b>CSV</b> (2 formats): ŒµŒØœÑŒµ <b>Category,Item</b> ŒµŒØœÑŒµ <b>ŒöŒ±œÑŒ∑Œ≥ŒøœÅŒØŒ±,ŒòŒ≠œÉŒ∑,User</b></li>
            </ul>
          </div>

          <label for="xlsxInput">.xlsx file</label>
          <input id="xlsxInput" type="file" accept=".xlsx,.csv" />
          <div style="height:10px"></div>

          <div class="row">
            <button class="btn ghost" id="importCancel" type="button">Cancel</button>
            <button class="btn primary" id="importApply" type="button">Apply to current profile</button>
          </div>

          <div class="muted" id="importHint" style="margin-top:10px;font-size:12px;">
            (ŒïœÄŒØŒªŒµŒæŒµ œÄœÅœéœÑŒ± profile Œ≥ŒπŒ± ŒΩŒ± ŒµœÜŒ±œÅŒºœåœÉŒµŒπ)
          </div>
        </div>
      </div>

      <!-- Stats (results) -->
      <div class="modal" id="statsModal" role="dialog" aria-modal="true">
        <div class="panel" style="max-width:380px;">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px;">
            <b style="letter-spacing:.08em;text-transform:uppercase;font-size:13px;">Statistics</b>
            <button class="btn small ghost" id="statsClose" type="button">‚úï</button>
          </div>

          <div class="row" style="margin-bottom:10px;">
            <button class="btn small primary" id="statsProfile" type="button">Current profile</button>
            <button class="btn small ghost" id="statsAll" type="button">All profiles</button>
          </div>

          <div class="scroll" id="statsContent" style="max-height:50vh;"></div>
        </div>
      </div>

      <!-- Stats access gate -->
      <div class="modal" id="statsCodeModal" role="dialog" aria-modal="true">
        <div class="panel" style="max-width:320px;">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px;">
            <b style="letter-spacing:.08em;text-transform:uppercase;font-size:13px;">Stats Access</b>
            <button class="btn small ghost" id="statsCodeClose" type="button">‚úï</button>
          </div>
          <label for="statsCodeInput">Access code</label>
          <input id="statsCodeInput" inputmode="numeric" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4"/>
          <div style="height:10px"></div>
          <div class="row">
            <button class="btn ghost" id="statsCodeCancel" type="button">Cancel</button>
            <button class="btn primary" id="statsCodeOk" type="button">Enter</button>
          </div>
          <div id="statsCodeErr" class="muted" style="margin-top:8px;color:rgba(255,77,109,.9);display:none;">
            Wrong code
          </div>
        </div>
      </div>

    </section>
  </div>

  <div class="desktop-hint">Mobile-first ‚Ä¢ stage simulates 9:16 (or 16:9 on desktop)</div>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
  apiKey: "AIzaSyA3j74FN_DIrsZclq09lIY62eenSOzP0yQ",
  authDomain: "euphoria-2026.firebaseapp.com",
  projectId: "euphoria-2026",
  storageBucket: "euphoria-2026.firebasestorage.app",
  messagingSenderId: "259023927428",
  appId: "1:259023927428:web:74099e69bea7b07a7b2ad1",
  measurementId: "G-JEVRCV89WB"
  };


  window.firebaseConfig = firebaseConfig;
  window.firebaseApp = initializeApp(firebaseConfig);
  window.db = getFirestore(window.firebaseApp);
</script>


  <script type="module">
      import { doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    /**********************************************************************
     * CONFIG
     **********************************************************************/
    const INTRO_SECONDS = 10;
    const STATS_CODE = "0825";

    const PROFILES = [
      { id: "teri-vi-sentio", name: "Teri Vi Sentio", code: "1478" },
      { id: "monhia", name: "Monhia", code: "9632" },
      { id: "lisjansi", name: "Lisjansi", code: "2365" },
    ];

    const CATEGORIES = [
      { id:"best-gr-song", title:"Best GR song" },
      { id:"best-foreign-song", title:"Best foreign song" },
      { id:"best-gr-male-artist", title:"Best GR Male Artist" },
      { id:"best-gr-female-artist", title:"Best GR Female Artist" },
      { id:"best-foreign-female-artist", title:"Best Foreign Female Artist" },
      { id:"best-foreign-male-artist", title:"Best Foreign Male Artist" },
      { id:"best-gr-music-video", title:"Best GR Music Video" },
      { id:"best-foreign-music-video", title:"Best Foreign Music Video" },
      { id:"best-performance-esc-25", title:"Best Performnce in ESC 25" },
      { id:"best-album", title:"Best Album" },
    ];

    const SCORE_BY_POS = [12,10,8,7,6,5,4,3,2,1];
    const LS_PREFIX = "neon-awards:";

    function DEFAULT_ITEMS(catId){
      const base = Array.from({length:10}, function(_,i){
        return { id: catId + "-" + (i+1), text: "Nominee " + (i+1) };
      });
      if (catId === "best-performance-esc-25") {
        base[0].text="Performance A"; base[1].text="Performance B"; base[2].text="Performance C";
      }
      if (catId === "best-album") {
        base[0].text="Album A"; base[1].text="Album B"; base[2].text="Album C";
      }
      return base;
    }

    /**********************************************************************
     * ROOM
     **********************************************************************/
    const params = new URLSearchParams(location.search);
    const ROOM_ID = (params.get("room") || "teri-vi-sentio").trim() || "teri-vi-sentio";

    /**********************************************************************
     * DOM
     **********************************************************************/
    const fx = document.getElementById("fx");
    const introLayer = document.getElementById("introLayer");
    const introCountdown = document.getElementById("introCountdown");
    const introMeter = document.getElementById("introMeter");
    const appLayer = document.getElementById("appLayer");

    const roomIdTxt = document.getElementById("roomIdTxt");
    const profileTxt = document.getElementById("profileTxt");
    const syncDot = document.getElementById("syncDot");
    const syncTxt = document.getElementById("syncTxt");

    const homeCard = document.getElementById("homeCard");
    const profilesGrid = document.getElementById("profilesGrid");

    const catsCard = document.getElementById("catsCard");
    const catsList = document.getElementById("catsList");
    const btnBackHome = document.getElementById("btnBackHome");
    const btnResetProfile = document.getElementById("btnResetProfile");

    const rankCard = document.getElementById("rankCard");
    const rankTitle = document.getElementById("rankTitle");
    const rankList = document.getElementById("rankList");
    const btnBackCats = document.getElementById("btnBackCats");
    const btnResetCat = document.getElementById("btnResetCat");
    const autosaveTxt = document.getElementById("autosaveTxt");

    const codeModal = document.getElementById("codeModal");
    const codeProfileName = document.getElementById("codeProfileName");
    const codeInput = document.getElementById("codeInput");
    const codeErr = document.getElementById("codeErr");
    const codeOk = document.getElementById("codeOk");
    const codeCancel = document.getElementById("codeCancel");
    const codeClose = document.getElementById("codeClose");

    const importModal = document.getElementById("importModal");
    const btnImport = document.getElementById("btnImport");
    const btnImportProfile = document.getElementById("btnImportProfile");
    const btnTemplate = document.getElementById("btnTemplate");
    const btnResetAll = document.getElementById("btnResetAll");
    const importClose = document.getElementById("importClose");
    const importCancel = document.getElementById("importCancel");
    const importApply = document.getElementById("importApply");
    const xlsxInput = document.getElementById("xlsxInput");
    const importHint = document.getElementById("importHint");

    const btnStats = document.getElementById("btnStats");
    const statsModal = document.getElementById("statsModal");
    const statsClose = document.getElementById("statsClose");
    const statsProfile = document.getElementById("statsProfile");
    const statsAll = document.getElementById("statsAll");
    const statsContent = document.getElementById("statsContent");

    const statsCodeModal = document.getElementById("statsCodeModal");
    const statsCodeInput = document.getElementById("statsCodeInput");
    const statsCodeOk = document.getElementById("statsCodeOk");
    const statsCodeCancel = document.getElementById("statsCodeCancel");
    const statsCodeClose = document.getElementById("statsCodeClose");
    const statsCodeErr = document.getElementById("statsCodeErr");

    const catsScroll = document.getElementById("catsScroll");
    const rankScroll = document.getElementById("rankScroll");



    /**********************************************************************
     * INTRO -> MAIN
     **********************************************************************/
    function startIntro(){
      introCountdown.textContent = INTRO_SECONDS.toFixed(1) + "s";
      introMeter.style.animationDuration = INTRO_SECONDS + "s";

      const t0 = performance.now();
      function tick(){
        const dt = (performance.now() - t0) / 1000;
        const left = Math.max(0, INTRO_SECONDS - dt);
        introCountdown.textContent = left.toFixed(1) + "s";
        if (left <= 0) { transitionToMain(); return; }
        requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
      setTimeout(transitionToMain, INTRO_SECONDS * 1000 + 120);
    }

    let didTransition = false;
    function transitionToMain(){
      if (didTransition) return;
      didTransition = true;
      fx.classList.add("active");
      setTimeout(function(){ appLayer.classList.add("active"); }, 220);
      setTimeout(function(){ if (introLayer) introLayer.remove(); }, 1100);
    }

    /**********************************************************************
     * STATE
     **********************************************************************/
    const lsKey = {
      category: function(profileId, catId){ return LS_PREFIX + "p:" + profileId + ":cat:" + catId; },
      profileMeta: function(profileId){ return LS_PREFIX + "p:" + profileId + ":meta"; }
    };

    function safeJsonParse(s, fallback){
      try { return JSON.parse(s); } catch (e) { return fallback; }
    }

    

    /**********************************************************************
     * FIRESTORE (cloud persistence)
     * - Saves every change to Firestore (so data never gets lost)
     * - Keeps localStorage as offline backup
     * NOTE: Fill firebaseConfig above. Firestore rules must allow read/write.
     **********************************************************************/
    const __cloudPulledOnce = Object.create(null);

    function __cloudConfigured(){
      // If user forgot to replace placeholders, treat as not configured.
      try{
        const cfg = window.firebaseConfig || null;
        if (!cfg) return false;
        const s = String(cfg.apiKey || "");
        return s && s.indexOf("ŒíŒëŒñŒïŒôŒ£") === -1 && s.indexOf("BAZEIS") === -1;
      }catch(e){ return false; }
    }

    function __cloudRef(profileId, catId){
      return doc(window.db, "rooms", ROOM_ID, "profiles", profileId, "categories", catId);
    }

    function __cloudSetStatus(){
      // UI: dot + text
      const ok = !!window.db && __cloudConfigured();
      const online = ok && navigator.onLine;
      syncDot.classList.remove("online","warn","bad");
      if (online){
        syncDot.classList.add("online");
        syncTxt.textContent = "online";
      } else if (ok){
        syncDot.classList.add("warn");
        syncTxt.textContent = "offline";
      } else {
        syncDot.classList.add("bad");
        syncTxt.textContent = "not configured";
      }
    }

    function __cloudPush(profileId, catId, items){
      if (!window.db || !__cloudConfigured()) return;
      setDoc(
        __cloudRef(profileId, catId),
        { items: items, updatedAt: serverTimestamp() },
        { merge: true }
      ).catch(function(){ /* ignore */ });
    }

    function __cloudPullOnce(profileId, catId, k){
      if (!window.db || !__cloudConfigured()) return;
      const key = profileId + "::" + catId;
      if (__cloudPulledOnce[key]) return;
      __cloudPulledOnce[key] = true;

      getDoc(__cloudRef(profileId, catId)).then(function(snap){
        if (!snap.exists()) return;
        const data = snap.data();
        if (!data || !Array.isArray(data.items)) return;

        // Cloud -> local backup
        localStorage.setItem(k, JSON.stringify(data.items));

        // If user is currently viewing this category, refresh UI
        if (currentProfile && currentCategory &&
            currentProfile.id === profileId && currentCategory.id === catId){
          renderRanking();
        } else if (currentProfile && currentProfile.id === profileId && catsCard.style.display !== "none"){
          renderCategories();
        }
      }).catch(function(){ /* ignore */ });
    }


    // Init / refresh sync indicator
    __cloudSetStatus();
    window.addEventListener("online", __cloudSetStatus);
    window.addEventListener("offline", __cloudSetStatus);
function getCategoryItems(profileId, catId){
      const k = lsKey.category(profileId, catId);

      // Try pull once from cloud (won't block UI)
      __cloudPullOnce(profileId, catId, k);

      const raw = localStorage.getItem(k);
      if (!raw){
        const seed = DEFAULT_ITEMS(catId);
        localStorage.setItem(k, JSON.stringify(seed));
        // also seed cloud (first time)
        __cloudPush(profileId, catId, seed);
        return seed;
      }
      const arr = safeJsonParse(raw, null);
      if (!Array.isArray(arr)){
        const seed2 = DEFAULT_ITEMS(catId);
        localStorage.setItem(k, JSON.stringify(seed2));
        __cloudPush(profileId, catId, seed2);
        return seed2;
      }
      return arr;
    }

    function setCategoryItems(profileId, catId, items){
      const k = lsKey.category(profileId, catId);
      // local backup (offline-safe)
      localStorage.setItem(k, JSON.stringify(items));
      // cloud save (so it never gets lost)
      __cloudPush(profileId, catId, items);
    }

    function resetCategory(profileId, catId){
      setCategoryItems(profileId, catId, DEFAULT_ITEMS(catId));
    }

    function resetProfile(profileId){
      for (let i=0; i<CATEGORIES.length; i++){
        localStorage.removeItem(lsKey.category(profileId, CATEGORIES[i].id));
      }
      localStorage.removeItem(lsKey.profileMeta(profileId));
    }

    function resetAllLocalInRoom(){
      const keys = Object.keys(localStorage);
      for (let i=0; i<keys.length; i++){
        if (keys[i].indexOf(LS_PREFIX) === 0) localStorage.removeItem(keys[i]);
      }
    }

    function computeScore(posIndex){
      return (posIndex >= 0 && posIndex < SCORE_BY_POS.length) ? SCORE_BY_POS[posIndex] : 0;
    }

    /**********************************************************************
     * NAV
     **********************************************************************/
    let currentProfile = null;
    let currentCategory = null;
    let pendingProfile = null;

    function showHome(){
      homeCard.style.display = "";
      catsCard.style.display = "none";
      rankCard.style.display = "none";
      currentCategory = null;
      profileTxt.textContent = currentProfile ? currentProfile.name : "‚Äî";
      importHint.textContent = currentProfile ? "ŒòŒ± ŒµœÜŒ±œÅŒºŒøœÉœÑŒµŒØ œÉœÑŒø œÑœÅŒ≠œáŒøŒΩ profile." : "(ŒïœÄŒØŒªŒµŒæŒµ œÄœÅœéœÑŒ± profile Œ≥ŒπŒ± ŒΩŒ± ŒµœÜŒ±œÅŒºœåœÉŒµŒπ)";
    }

    function showCategories(){
      if (!currentProfile) return;
      homeCard.style.display = "none";
      catsCard.style.display = "";
      rankCard.style.display = "none";
      renderCategories();
    }

    function showRanking(catId){
      if (!currentProfile) return;
      currentCategory = null;
      for (let i=0;i<CATEGORIES.length;i++){
        if (CATEGORIES[i].id === catId) { currentCategory = CATEGORIES[i]; break; }
      }
      if (!currentCategory) return;
      homeCard.style.display = "none";
      catsCard.style.display = "none";
      rankCard.style.display = "";
      renderRanking();
    }

    /**********************************************************************
     * RENDER: Profiles
     **********************************************************************/
    function renderProfiles(){
      profilesGrid.innerHTML = "";
      for (let i=0; i<PROFILES.length; i++){
        const p = PROFILES[i];
        const el = document.createElement("div");
        el.className = "tile";
        el.innerHTML =
          "<b>" + escapeHtml(p.name) + "</b>" +
          "<small>Tap to unlock</small><br/>" +
          "<span class='kbd'>code required</span>";
        el.addEventListener("click", function(){
          pendingProfile = p;
          openCodeModal(p);
        });
        profilesGrid.appendChild(el);
      }
    }

    /**********************************************************************
     * RENDER: Categories
     **********************************************************************/
    function renderCategories(){
      profileTxt.textContent = currentProfile ? currentProfile.name : "‚Äî";
      catsList.innerHTML = "";

      for (let i=0; i<CATEGORIES.length; i++){
        const c = CATEGORIES[i];
        const items = getCategoryItems(currentProfile.id, c.id);
        const top3 = items.slice(0,3).map(function(x,idx){ return (idx+1) + ". " + x.text; }).join(" ‚Ä¢ ");

        const el = document.createElement("div");
        el.className = "tile";
        el.style.minHeight = "90px";
        el.innerHTML =
          "<b>" + escapeHtml(c.title) + "</b>" +
          "<small class='muted'>" + escapeHtml(top3 || "‚Äî") + "</small><br/>" +
          "<span class='kbd'>" + items.length + " nominees</span>";

        el.addEventListener("click", (function(catId){ return function(){ showRanking(catId); }; })(c.id));
        catsList.appendChild(el);
      }
    }

    /**********************************************************************
     * RENDER: Ranking + Sortable
     **********************************************************************/
    let sortable = null;

    function renderRanking(){
      const cat = currentCategory;
      rankTitle.textContent = cat.title;

      const items = getCategoryItems(currentProfile.id, cat.id);
      rankList.innerHTML = "";

      for (let i=0; i<items.length; i++){
        const it = items[i];
        const row = document.createElement("div");
        row.className = "item";
        row.dataset.id = it.id;
        row.innerHTML =
          "<div class='handle' aria-hidden='true'>‚â°</div>" +
          "<div class='name'>" + escapeHtml(it.text) + "</div>" +
          "<div class='badge' title='Score'>" + computeScore(i) + "</div>" +
          "<div class='mctl' aria-label='Reorder'>" +
          "<button class='up' type='button' aria-label='Move up'>‚ñ≤</button>" +
          "<button class='down' type='button' aria-label='Move down'>‚ñº</button>" +
          "</div>";
        
// Touch-friendly reorder (buttons) on coarse pointer devices
const __isCoarse = window.matchMedia && window.matchMedia("(pointer: coarse)").matches;
if (__isCoarse){
  const upBtn = row.querySelector(".up");
  const downBtn = row.querySelector(".down");
  const doMove = (dir) => {
    const idxNow = items.findIndex(x => x.id === it.id);
    if (idxNow < 0) return;
    const next = idxNow + dir;
    if (next < 0 || next >= items.length) return;
    const newOrder = items.slice();
    const tmp = newOrder[idxNow];
    newOrder[idxNow] = newOrder[next];
    newOrder[next] = tmp;
    setCategoryItems(currentProfile.id, cat.id, newOrder);
  };
  if (upBtn) upBtn.addEventListener("click", (e)=>{ e.preventDefault(); e.stopPropagation(); doMove(-1); });
  if (downBtn) downBtn.addEventListener("click", (e)=>{ e.preventDefault(); e.stopPropagation(); doMove(1); });
}

        rankList.appendChild(row);
      }

      if (sortable) sortable.destroy();
      sortable = null;
      const __isCoarseList = window.matchMedia && window.matchMedia("(pointer: coarse)").matches;
      if (!__isCoarseList) {
        sortable = new Sortable(rankList, {
        animation: 160,
        handle: ".handle",
        onEnd: function(){
          const newOrder = [];
          const nodes = rankList.querySelectorAll(".item");
          for (let i=0; i<nodes.length; i++){
            const id = nodes[i].dataset.id;
            for (let j=0; j<items.length; j++){
              if (items[j].id === id) { newOrder.push(items[j]); break; }
            }
          }
          // ensure none lost
          for (let k=0; k<items.length; k++){
            let found = false;
            for (let z=0; z<newOrder.length; z++){
              if (newOrder[z].id === items[k].id) { found = true; break; }
            }
            if (!found) newOrder.push(items[k]);
          }

          setCategoryItems(currentProfile.id, cat.id, newOrder);
          autosavePulse();
          updateBadges();
        }
      });
      }

      updateBadges();
    }

    function updateBadges(){
      const badges = rankList.querySelectorAll(".badge");
      for (let i=0; i<badges.length; i++){
        badges[i].textContent = computeScore(i);
      }
    }

    function autosavePulse(){
      autosaveTxt.textContent = "saved ‚úì";
      autosaveTxt.style.opacity = "1";
      setTimeout(function(){
        autosaveTxt.textContent = "saved";
        autosaveTxt.style.opacity = ".8";
      }, 700);
    }

    /**********************************************************************
     * MODAL MANAGER (one modal at a time)
     **********************************************************************/
    const ALL_MODALS = [codeModal, importModal, statsModal, statsCodeModal];

    function closeAllModals(){
      for (let i=0; i<ALL_MODALS.length; i++){
        if (ALL_MODALS[i]) ALL_MODALS[i].classList.remove("show");
      }
      if (codeInput) codeInput.blur();
      if (statsCodeInput) statsCodeInput.blur();
    }

    function wireModalBackdrop(modal, closeFn){
      if (!modal) return;
      modal.addEventListener("click", function(e){
        if (e.target === modal) closeFn();
      });
    }

    /**********************************************************************
     * PROFILE CODE MODAL
     **********************************************************************/
    function openCodeModal(profile){
      closeAllModals();
      codeProfileName.textContent = profile.name;
      codeInput.value = "";
      codeErr.style.display = "none";
      codeModal.classList.add("show");
      setTimeout(function(){ codeInput.focus(); }, 50);
    }

    function closeCodeModal(){
      codeModal.classList.remove("show");
      codeInput.blur();
    }

    function tryUnlock(){
      if (!pendingProfile) return;
      const ok = String(codeInput.value || "").trim() === String(pendingProfile.code);
      if (!ok){
        codeErr.style.display = "";
        if (codeInput.select) codeInput.select();
        return;
      }
      currentProfile = pendingProfile;
      pendingProfile = null;
      closeCodeModal();
      showCategories();
    }

    codeOk.addEventListener("click", tryUnlock);
    codeInput.addEventListener("keydown", function(e){ if (e.key === "Enter") tryUnlock(); });
    codeCancel.addEventListener("click", closeCodeModal);
    codeClose.addEventListener("click", closeCodeModal);
    wireModalBackdrop(codeModal, closeCodeModal);

    /**********************************************************************
     * IMPORT MODAL
     **********************************************************************/
    function openImportModal(){
      closeAllModals();
      importModal.classList.add("show");
      xlsxInput.value = "";
      importHint.textContent = currentProfile ? "ŒòŒ± ŒµœÜŒ±œÅŒºŒøœÉœÑŒµŒØ œÉœÑŒø œÑœÅŒ≠œáŒøŒΩ profile." : "(ŒïœÄŒØŒªŒµŒæŒµ œÄœÅœéœÑŒ± profile Œ≥ŒπŒ± ŒΩŒ± ŒµœÜŒ±œÅŒºœåœÉŒµŒπ)";
    }
    function closeImportModal(){ importModal.classList.remove("show"); }

    btnImport.addEventListener("click", openImportModal);
    if (btnImportProfile) btnImportProfile.addEventListener("click", openImportModal);
    if (btnImportProfile) btnImportProfile.addEventListener("click", openImportModal);

    /**********************************************************************
     * TEMPLATE DOWNLOAD (XLSX) ‚Äî embedded (no CDN, no libraries)
     * ŒöŒ±œÑŒ≠Œ≤Œ±œÉŒµ Œ∫Œ±Œ∏Œ±œÅœå Excel. ŒìœÅŒ¨œÜŒµŒπœÇ œÑŒøœÖœÇ œÖœÄŒøœàŒ∑œÜŒØŒøœÖœÇ œÉœÑŒ∑ Œ£Œ§ŒóŒõŒó C.
     **********************************************************************/
    const EMBEDDED_TEMPLATE_XLSX_B64 = "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";

    function downloadTemplateXlsx(){
      const binary = atob(EMBEDDED_TEMPLATE_XLSX_B64);
      const bytes = new Uint8Array(binary.length);
      for (let i=0; i<binary.length; i++) bytes[i] = binary.charCodeAt(i);
      const blob = new Blob([bytes], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "Euphoria-Neon-Awards-TEMPLATE.xlsx";
      document.body.appendChild(a);
      a.click();
      setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 0);
    }

    if (btnTemplate){
      btnTemplate.addEventListener("click", () => {
        closeAllModals();
        downloadTemplateXlsx();
      });
    }

    /**********************************************************************
     * TEMPLATE DOWNLOAD (CSV) ‚Äî works offline / everywhere (no external libs)
     * Two supported CSV formats for IMPORT:
     *  A) Category,Item
     *  B) ŒöŒ±œÑŒ∑Œ≥ŒøœÅŒØŒ±,ŒòŒ≠œÉŒ∑,<UserColumn>   (xlsx-style; category can be blank in subsequent rows)
     **********************************************************************/
    function csvCell(s){
      var t = String(s == null ? "" : s).replace(/"/g,'""');
      return '"' + t + '"';
    }

    function downloadTemplateCSV(){
      // Like your Excel: columns ŒöŒ±œÑŒ∑Œ≥ŒøœÅŒØŒ± | ŒòŒ≠œÉŒ∑ | <ProfileName>
      var profileName = currentProfile ? currentProfile.name : "User";
      var header = ["ŒöŒ±œÑŒ∑Œ≥ŒøœÅŒØŒ±", "ŒòŒ≠œÉŒ∑", profileName];

      var TITLE_MAP = {
        "best-gr-song": "BEST GR SONG",
        "best-foreign-song": "BEST FOREIGN SONG",
        "best-gr-male-artist": "BEST GR MALE ARTIST",
        "best-gr-female-artist": "BEST GR FEMALE ARTIST",
        "best-foreign-female-artist": "BEST FOREIGN FEMALE ARTIST",
        "best-foreign-male-artist": "BEST FOREIGN MALE ARTIST",
        "best-gr-music-video": "BEST GR MUSIC VIDEO",
        "best-foreign-music-video": "BEST FOREIGN MUSIC VIDEO",
        "best-performance-esc-25": "BEST ESC 25 PERFORMANCE",
        "best-album": "ALBUM OF THE YEAR"
      };

      var lines = [];
      lines.push(header.map(csvCell).join(","));

      for (var i=0; i<CATEGORIES.length; i++){
        var cat = CATEGORIES[i];
        var title = String((TITLE_MAP[cat.id] || cat.title)).toUpperCase();

        // Positions as a guide only ‚Äî you may add/remove rows freely.
        var N = (cat.id === "best-gr-song") ? 11 : 10;

        for (var pos=1; pos<=N; pos++){
          var catCell = (pos === 1) ? title : "";
          lines.push([catCell, String(pos), ""].map(csvCell).join(","));
        }
        lines.push("");
      }

      lines.push([ "(Notes)", "", "Œ£œÖŒºœÄŒªŒÆœÅœâœÉŒµ nominees œÉœÑŒ∑ŒΩ 3Œ∑ œÉœÑŒÆŒªŒ∑. ŒúœÄŒøœÅŒµŒØœÇ ŒΩŒ± Œ≤Œ¨ŒªŒµŒπœÇ œåœÉŒµœÇ Œ≥œÅŒ±ŒºŒºŒ≠œÇ Œ∏ŒµœÇ Œ±ŒΩŒ¨ Œ∫Œ±œÑŒ∑Œ≥ŒøœÅŒØŒ± (3/15/16/50‚Ä¶)."].map(csvCell).join(","));
      lines.push([ "(Notes)", "", "Œó ŒöŒ±œÑŒ∑Œ≥ŒøœÅŒØŒ± ŒºœÄŒøœÅŒµŒØ ŒΩŒ± ŒµŒØŒΩŒ±Œπ ŒºœåŒΩŒø œÉœÑŒ∑ŒΩ œÄœÅœéœÑŒ∑ Œ≥œÅŒ±ŒºŒºŒÆ œÑŒøœÖ block (ŒøŒπ Œ∫Œ¨œÑœâ ŒºœÄŒøœÅŒøœçŒΩ ŒΩŒ± ŒµŒØŒΩŒ±Œπ Œ∫ŒµŒΩŒ≠œÇ)."].map(csvCell).join(","));
      lines.push([ "(Notes)", "", "ŒìŒπŒ± Œ∫Œ¨Œ∏Œµ user: ŒºœÄŒµœÇ œÉœÑŒø Œ±ŒΩœÑŒØœÉœÑŒøŒπœáŒø profile Œ∫Œ±Œπ Œ∫Œ¨ŒΩŒµ Import œÑŒø Œ¥ŒπŒ∫œå œÑŒøœÖ CSV."].map(csvCell).join(","));

      var blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
      var a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "Euphoria-Neon-Awards-Template.csv";
      document.body.appendChild(a);
      a.click();
      setTimeout(function(){ URL.revokeObjectURL(a.href); a.remove(); }, 0);
    }

    // Minimal CSV parser (quotes, commas, CRLF)
    function parseCSV(text){
      var rows = [];
      var i = 0, field = "", row = [], inQuotes = false;

      function endField(){ row.push(field); field=""; }
      function endRow(){ rows.push(row); row=[]; }

      while (i < text.length){
        var c = text[i];

        if (inQuotes){
          if (c === '"'){
            if (text[i+1] === '"'){ field += '"'; i += 2; continue; }
            inQuotes = false; i++; continue;
          }
          field += c; i++; continue;
        } else {
          if (c === '"'){ inQuotes = true; i++; continue; }
          if (c === ','){ endField(); i++; continue; }
          if (c === '\r'){ i++; continue; }
          if (c === '\n'){ endField(); endRow(); i++; continue; }
          field += c; i++; continue;
        }
      }
      endField();
      if (row.length) endRow();
      return rows;
    }

/**********************************************************************
 * Minimal XLSX reader (no external libraries)
 * Works in modern Chromium browsers (uses DecompressionStream).
 * Supports simple .xlsx with strings/numbers and first worksheet.
 **********************************************************************/
function u32le(d, o){ return (d[o] | (d[o+1]<<8) | (d[o+2]<<16) | (d[o+3]<<24))>>>0; }
function u16le(d, o){ return (d[o] | (d[o+1]<<8))>>>0; }

async function inflateRaw(uint8){
  if (!("DecompressionStream" in window)) throw new Error("Browser doesn't support DecompressionStream (needed for XLSX).");
  const ds = new DecompressionStream("deflate-raw");
  const stream = new Blob([uint8]).stream().pipeThrough(ds);
  const ab = await new Response(stream).arrayBuffer();
  return new Uint8Array(ab);
}

function findEOCD(d){
  const sig = 0x06054b50;
  const start = Math.max(0, d.length - 70000);
  for (let i=d.length-22; i>=start; i--){
    if (u32le(d,i) === sig) return i;
  }
  return -1;
}

async function unzipEntry(d, entry){
  const off = entry.localOffset;
  if (u32le(d, off) !== 0x04034b50) throw new Error("Bad local header for " + entry.name);
  const nameLen = u16le(d, off+26);
  const extraLen = u16le(d, off+28);
  const dataStart = off + 30 + nameLen + extraLen;
  const comp = d.slice(dataStart, dataStart + entry.compSize);
  if (entry.method === 0) return comp;
  if (entry.method === 8) return await inflateRaw(comp);
  throw new Error("Unsupported compression method " + entry.method + " for " + entry.name);
}

async function unzipXlsx(arrayBuffer){
  const d = new Uint8Array(arrayBuffer);
  const eocd = findEOCD(d);
  if (eocd < 0) throw new Error("Not a ZIP/XLSX file (EOCD not found).");
  const cdSize = u32le(d, eocd+12);
  const cdOff  = u32le(d, eocd+16);
  let p = cdOff;
  const entries = [];
  while (p < cdOff + cdSize){
    if (u32le(d,p) !== 0x02014b50) break;
    const method = u16le(d, p+10);
    const compSize = u32le(d, p+20);
    const uncompSize = u32le(d, p+24);
    const nameLen = u16le(d, p+28);
    const extraLen = u16le(d, p+30);
    const commentLen = u16le(d, p+32);
    const localOffset = u32le(d, p+42);
    const nameBytes = d.slice(p+46, p+46+nameLen);
    const name = new TextDecoder("utf-8").decode(nameBytes);
    entries.push({ name, method, compSize, uncompSize, localOffset });
    p = p + 46 + nameLen + extraLen + commentLen;
  }
  const sheets = entries.filter(e => /^xl\/worksheets\/sheet\d+\.xml$/i.test(e.name));
  if (!sheets.length) throw new Error("No worksheets found in XLSX.");
  sheets.sort((a,b)=>a.name.localeCompare(b.name));
  const sheet = sheets.find(s=>/sheet1\.xml$/i.test(s.name)) || sheets[0];
  const shared = entries.find(e => /xl\/sharedStrings\.xml$/i.test(e.name));

  const out = {};
  out[sheet.name] = new TextDecoder("utf-8").decode(await unzipEntry(d, sheet));
  if (shared) out[shared.name] = new TextDecoder("utf-8").decode(await unzipEntry(d, shared));
  return out;
}

function colToIndex(col){
  let n = 0;
  for (let i=0; i<col.length; i++){
    const c = col.charCodeAt(i);
    if (c>=65 && c<=90) n = n*26 + (c-64);
    else if (c>=97 && c<=122) n = n*26 + (c-96);
  }
  return n-1;
}

function parseSharedStrings(xml){
  const doc = new DOMParser().parseFromString(xml, "application/xml");
  const si = doc.getElementsByTagName("si");
  const out = [];
  for (let i=0; i<si.length; i++){
    const tNodes = si[i].getElementsByTagName("t");
    let s = "";
    for (let j=0; j<tNodes.length; j++) s += (tNodes[j].textContent || "");
    out.push(s);
  }
  return out;
}

function parseSheetXmlToRows(sheetXml, sharedStrings){
  const doc = new DOMParser().parseFromString(sheetXml, "application/xml");
  const rows = [];
  const rowNodes = doc.getElementsByTagName("row");
  for (let i=0; i<rowNodes.length; i++){
    const rNode = rowNodes[i];
    const rIndex = parseInt(rNode.getAttribute("r") || "0", 10) - 1;
    if (rIndex < 0) continue;
    if (!rows[rIndex]) rows[rIndex] = [];
    const cNodes = rNode.getElementsByTagName("c");
    for (let j=0; j<cNodes.length; j++){
      const cNode = cNodes[j];
      const ref = cNode.getAttribute("r") || "";
      const mm = ref.match(/^([A-Za-z]+)(\d+)$/);
      if (!mm) continue;
      const col = colToIndex(mm[1]);
      const t = cNode.getAttribute("t") || "";
      let v = "";
      if (t === "s"){
        const vNode = cNode.getElementsByTagName("v")[0];
        const idx = vNode ? parseInt(vNode.textContent || "0", 10) : 0;
        v = sharedStrings[idx] || "";
      } else if (t === "inlineStr"){
        const tNode = cNode.getElementsByTagName("t")[0];
        v = tNode ? (tNode.textContent || "") : "";
      } else {
        const vNode = cNode.getElementsByTagName("v")[0];
        v = vNode ? (vNode.textContent || "") : "";
      }
      rows[rIndex][col] = v;
    }
  }
  return rows.map(r => (r || []).map(x => (x==null?"":String(x))));
}

async function parseXlsxMinimal(file){
  const ab = await file.arrayBuffer();
  const files = await unzipXlsx(ab);
  const sheetName = Object.keys(files).find(k => /xl\/worksheets\/sheet\d+\.xml$/i.test(k));
  const sharedName = Object.keys(files).find(k => /xl\/sharedStrings\.xml$/i.test(k));
  const shared = sharedName ? parseSharedStrings(files[sharedName]) : [];
  return parseSheetXmlToRows(files[sheetName], shared);
}


    // Normalizes category titles for mapping
    function normalizeCsvTitle(s){
      return String(s || "").trim().toLowerCase().replace(/\s+/g," ");
    }

    // Map normalized titles to category ids (from app categories)
    var catTitleToIdCsv = new Map(CATEGORIES.map(function(c){ return [normalizeCsvTitle(c.title), c.id]; }));
    // Also accept the template uppercase titles we generate
    (function(){
      var extra = {
        "best gr song": "best-gr-song",
        "best foreign song": "best-foreign-song",
        "best gr male artist": "best-gr-male-artist",
        "best gr female artist": "best-gr-female-artist",
        "best foreign female artist": "best-foreign-female-artist",
        "best foreign male artist": "best-foreign-male-artist",
        "best gr music video": "best-gr-music-video",
        "best foreign music video": "best-foreign-music-video",
        "best esc 25 performance": "best-performance-esc-25",
        "album of the year": "best-album",
        "best greek song": "best-gr-song",
        "best gr songs": "best-gr-song",
        "best greek male artist": "best-gr-male-artist",
        "best greek female artist": "best-gr-female-artist",
        "best greek music video": "best-gr-music-video",
        "best foreign male artist": "best-foreign-male-artist",
        "best foreign female artist": "best-foreign-female-artist",
        "best foreign music video": "best-foreign-music-video",
        "best performance in esc 25": "best-performance-esc-25",
        "best performnce in esc 25": "best-performance-esc-25",
        "best esc 25 performance": "best-performance-esc-25",
        "best gr album": "best-album",

      };
      for (var k in extra) catTitleToIdCsv.set(k, extra[k]);
    })();

    if (btnTemplate){
      btnTemplate.addEventListener("click", function(){
        closeAllModals();
        downloadTemplateCSV();
      });
    }

    importCancel.addEventListener("click", closeImportModal);
    importClose.addEventListener("click", closeImportModal);
    wireModalBackdrop(importModal, closeImportModal);

    function normalizeCatTitle(s){
      return String(s || "").trim().toLowerCase().replace(/\s+/g," ");
    }
    const catTitleToId = new Map(CATEGORIES.map(function(c){ return [normalizeCatTitle(c.title), c.id]; }));

    function readXlsx(file){
      return new Promise(function(resolve, reject){
        const reader = new FileReader();
        reader.onload = function(ev){
          try{
            const data = new Uint8Array(ev.target.result);
            const wb = XLSX.read(data, {type:"array"});
            resolve(wb);
          }catch(err){ reject(err); }
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

    function extractMappingFromWorkbook(wb){
      const out = new Map();

      // A) sheet name == category title, items column A
      for (let s=0; s<wb.SheetNames.length; s++){
        const sheetName = wb.SheetNames[s];
        const norm = normalizeCatTitle(sheetName);
        if (!catTitleToId.has(norm)) continue;
        const catId = catTitleToId.get(norm);

        const ws = wb.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(ws, {header:1, blankrows:false});
        const texts = [];
        for (let r=0; r<rows.length; r++){
          const cell = (rows[r] && rows[r][0] != null) ? String(rows[r][0]).trim() : "";
          if (cell) texts.push(cell);
        }
        if (texts.length) out.set(catId, texts);
      }

      // B) columns Category / Item
      if (out.size === 0){
        for (let s2=0; s2<wb.SheetNames.length; s2++){
          const ws2 = wb.Sheets[wb.SheetNames[s2]];
          const json = XLSX.utils.sheet_to_json(ws2, {defval:""});
          let hasCat = false, hasItem = false;
          for (let i=0; i<json.length; i++){
            if ("Category" in json[i] || "category" in json[i]) hasCat = true;
            if ("Item" in json[i] || "item" in json[i]) hasItem = true;
          }
          if (!hasCat || !hasItem) continue;

          for (let i2=0; i2<json.length; i2++){
            const row = json[i2];
            const catRaw = row.Category || row.category || "";
            const itemRaw = row.Item || row.item || "";
            const catNorm = normalizeCatTitle(catRaw);
            const catId2 = catTitleToId.get(catNorm);
            if (!catId2) continue;
            const text = String(itemRaw).trim();
            if (!text) continue;
            if (!out.has(catId2)) out.set(catId2, []);
            out.get(catId2).push(text);
          }
          if (out.size) break;
        }
      }

      return out;
    }

    async function applyImport(){
  if (!currentProfile){
    importHint.textContent = "Œ†œÅŒ≠œÄŒµŒπ ŒΩŒ± ŒµœÄŒπŒªŒ≠ŒæŒµŒπœÇ profile œÄœÅœéœÑŒ±.";
    return;
  }
  var file = (xlsxInput.files && xlsxInput.files[0]) ? xlsxInput.files[0] : null;
  if (!file){
    importHint.textContent = "ŒîŒπŒ¨ŒªŒµŒæŒµ Œ≠ŒΩŒ± .xlsx ŒÆ .csv Œ±œÅœáŒµŒØŒø.";
    return;
  }

  try{
    importHint.textContent = "Reading‚Ä¶";
    var name = String(file.name || "").toLowerCase();
    var mapping = new Map();

    if (name.endsWith(".csv")){
      var csvText = await file.text();
      var rows = parseCSV(csvText);
      if (!rows.length){ importHint.textContent = "Empty CSV."; return; }

      var h0 = String(rows[0][0] || "").trim().toLowerCase();
      var h1 = String(rows[0][1] || "").trim().toLowerCase();
      var isA = (h0 === "category" && h1 === "item");
      var isB = (h0 === "Œ∫Œ±œÑŒ∑Œ≥ŒøœÅŒØŒ±" && h1 === "Œ∏Œ≠œÉŒ∑");
      var startRow = (isA || isB) ? 1 : 0;

      if (isA){
        for (var r = startRow; r < rows.length; r++){
          var catRaw = String(rows[r]?.[0] || "").trim();
          var itemRaw = String(rows[r]?.[1] || "").trim();
          if (!catRaw || !itemRaw) continue;
          var catId = catTitleToIdCsv.get(normalizeCsvTitle(catRaw));
          if (!catId) continue;
          if (!mapping.has(catId)) mapping.set(catId, []);
          mapping.get(catId).push({ pos: mapping.get(catId).length + 1, text: itemRaw });
        }
      } else {
        var lastCat = "";
        for (var r2 = startRow; r2 < rows.length; r2++){
          var catCell = String(rows[r2]?.[0] || "").trim();
          var posCell = String(rows[r2]?.[1] || "").trim();
          var textCell = String(rows[r2]?.[2] || "").trim();
          if (catCell) lastCat = catCell;
          if (!lastCat || !textCell) continue;
          var posNum = parseInt(posCell, 10);
          if (!isFinite(posNum) || posNum < 1) posNum = 999999;
          var catId2 = catTitleToIdCsv.get(normalizeCsvTitle(lastCat));
          if (!catId2) continue;
          if (!mapping.has(catId2)) mapping.set(catId2, []);
          mapping.get(catId2).push({ pos: posNum, text: textCell });
        }
      }
    } else if (name.endsWith(".xlsx")){
      // XLSX without external libs
      var xrows = await parseXlsxMinimal(file);
      if (!xrows.length){ importHint.textContent = "Empty XLSX."; return; }

      var hh0 = String((xrows[0] && xrows[0][0]) || "").trim().toLowerCase();
      var hh1 = String((xrows[0] && xrows[0][1]) || "").trim().toLowerCase();
      var isAx = (hh0 === "category" && hh1 === "item");
      var isBx = (hh0 === "Œ∫Œ±œÑŒ∑Œ≥ŒøœÅŒØŒ±" && hh1 === "Œ∏Œ≠œÉŒ∑");
      var startX = (isAx || isBx) ? 1 : 0;

      if (isAx){
        for (var xr = startX; xr < xrows.length; xr++){
          var catRawX = String((xrows[xr] && xrows[xr][0]) || "").trim();
          var itemRawX = String((xrows[xr] && xrows[xr][1]) || "").trim();
          if (!catRawX || !itemRawX) continue;
          var catIdx = catTitleToIdCsv.get(normalizeCsvTitle(catRawX));
          if (!catIdx) continue;
          if (!mapping.has(catIdx)) mapping.set(catIdx, []);
          mapping.get(catIdx).push({ pos: mapping.get(catIdx).length + 1, text: itemRawX });
        }
      } else {
        var lastCatX = "";
        for (var xr2 = startX; xr2 < xrows.length; xr2++){
          var catCellX = String((xrows[xr2] && xrows[xr2][0]) || "").trim();
          var posCellX = String((xrows[xr2] && xrows[xr2][1]) || "").trim();
          var textCellX = String((xrows[xr2] && xrows[xr2][2]) || "").trim();
          if (catCellX) lastCatX = catCellX;
          if (!lastCatX || !textCellX) continue;
          var posNumX = parseInt(posCellX, 10);
          if (!isFinite(posNumX) || posNumX < 1) posNumX = 999999;
          var catIdX2 = catTitleToIdCsv.get(normalizeCsvTitle(lastCatX));
          if (!catIdX2) continue;
          if (!mapping.has(catIdX2)) mapping.set(catIdX2, []);
          mapping.get(catIdX2).push({ pos: posNumX, text: textCellX });
        }
      }
    } else {
      importHint.textContent = "Unsupported file. Use .xlsx or .csv";
      return;
    }

    if (!mapping || mapping.size === 0){
      importHint.textContent = "ŒîŒµŒΩ Œ≤œÅŒ≠Œ∏Œ∑Œ∫Œµ mapping. ŒàŒªŒµŒ≥ŒæŒµ format / Œ∫Œ±œÑŒ∑Œ≥ŒøœÅŒØŒµœÇ.";
      return;
    }

    mapping.forEach(function(entries, catId){
      entries.sort(function(a,b){ return (a.pos||999999) - (b.pos||999999); });
      var items = entries.map(function(e, i){
        return { id: catId + "-imp-" + (i+1), text: e.text };
      });
      setCategoryItems(currentProfile.id, catId, items);
    });

    importHint.textContent = "Applied to " + currentProfile.name + ".";
    renderCategories();
    if (currentCategory) renderRanking();
  }catch(err){
    console.error(err);
    importHint.textContent = "Import failed: " + (err && err.message ? err.message : "see console");
  }
}

importApply.addEventListener("click", applyImport);

    /**********************************************************************
     * STATS (LOCKED)
     **********************************************************************/
    function openStatsGate(){
      closeAllModals();
      statsCodeErr.style.display = "none";
      statsCodeInput.value = "";
      statsCodeModal.classList.add("show");
      setTimeout(function(){ statsCodeInput.focus(); }, 40);
    }
    function closeStatsGate(){
      statsCodeModal.classList.remove("show");
      statsCodeInput.blur();
    }

    function openStats(){
      closeAllModals();
      statsModal.classList.add("show");
      renderStats("profile");
    }
    function closeStats(){
      statsModal.classList.remove("show");
    }

    function tryStatsCode(){
      const v = String(statsCodeInput.value || "").trim();
      if (v === STATS_CODE){
        closeStatsGate();
        openStats();
      }else{
        statsCodeErr.style.display = "";
        if (statsCodeInput.select) statsCodeInput.select();
      }
    }

    btnStats.addEventListener("click", openStatsGate);
    btnStats.addEventListener("touchstart", function(){ /* mobile reliability */ openStatsGate(); }, {passive:true});

    statsCodeOk.addEventListener("click", tryStatsCode);
    statsCodeInput.addEventListener("keydown", function(e){ if (e.key === "Enter") tryStatsCode(); });
    statsCodeCancel.addEventListener("click", closeStatsGate);
    statsCodeClose.addEventListener("click", closeStatsGate);
    wireModalBackdrop(statsCodeModal, closeStatsGate);

    statsClose.addEventListener("click", closeStats);
    wireModalBackdrop(statsModal, closeStats);

    statsProfile.addEventListener("click", function(){ renderStats("profile"); });
    statsAll.addEventListener("click", function(){ renderStats("all"); });

    function setStatsMode(mode){
      if (mode === "profile"){
        statsProfile.classList.add("primary"); statsProfile.classList.remove("ghost");
        statsAll.classList.add("ghost"); statsAll.classList.remove("primary");
      }else{
        statsAll.classList.add("primary"); statsAll.classList.remove("ghost");
        statsProfile.classList.add("ghost"); statsProfile.classList.remove("primary");
      }
    }

    function renderStats(mode){
      setStatsMode(mode);
      if (!statsContent) return;

      const profiles = (mode === "profile")
        ? (currentProfile ? [currentProfile] : [])
        : PROFILES;

      let htmlOut = "";

      for (let c=0; c<CATEGORIES.length; c++){
        const cat = CATEGORIES[c];
        const totals = Object.create(null);

        for (let p=0; p<profiles.length; p++){
          const prof = profiles[p];
          if (!prof) continue;
          const items = getCategoryItems(prof.id, cat.id);
          for (let i=0; i<items.length; i++){
            const it = items[i];
            const name = (it && it.text) ? it.text : "(untitled)";
            const score = computeScore(i);
            totals[name] = (totals[name] || 0) + score;
          }
        }

        const ranked = Object.entries(totals).sort(function(a,b){ return b[1]-a[1]; });
        if (!ranked.length) continue;

        let rows = "";
        for (let r=0; r<ranked.length; r++){
          rows += '<div class="item" style="cursor:default; touch-action:pan-y;">'
                +   '<div class="handle">' + (r+1) + '</div>'
                +   '<div class="name">' + escapeHtml(ranked[r][0]) + '</div>'
                +   '<div class="badge">' + ranked[r][1] + '</div>'
                + '</div>';
        }

        htmlOut += '<div class="card" style="margin-bottom:10px;">'
                +   '<div class="hd"><h2>' + escapeHtml(cat.title) + '</h2></div>'
                +   '<div class="bd">' + rows + '</div>'
                + '</div>';
      }

      statsContent.innerHTML = htmlOut || "<div class='muted'>No data yet.</div>";
    }

    /**********************************************************************
     * BUTTONS
     **********************************************************************/
    btnBackHome.addEventListener("click", function(){
      currentProfile = null;
      showHome();
      profileTxt.textContent = "‚Äî";
    });

    btnBackCats.addEventListener("click", showCategories);

    btnResetCat.addEventListener("click", function(){
      if (!currentProfile || !currentCategory) return;
      resetCategory(currentProfile.id, currentCategory.id);
      renderRanking();
    });

    btnResetProfile.addEventListener("click", function(){
      if (!currentProfile) return;
      resetProfile(currentProfile.id);
      renderCategories();
    });

    btnResetAll.addEventListener("click", function(){
      resetAllLocalInRoom();
      showHome();
    });

    /**********************************************************************
     * iOS scroll fallback
     **********************************************************************/
    function attachTouchScrollFallback(scrollEl){
      let startY = 0;
      let startTop = 0;
      scrollEl.addEventListener("touchstart", function(e){
        if (!e.touches || e.touches.length !== 1) return;
        startY = e.touches[0].clientY;
        startTop = scrollEl.scrollTop;
      }, {passive:true});

      scrollEl.addEventListener("touchmove", function(e){
        if (!e.touches || e.touches.length !== 1) return;
        const dy = startY - e.touches[0].clientY;
        if (Math.abs(dy) > 1) scrollEl.scrollTop = startTop + dy;
      }, {passive:true});
    }

    attachTouchScrollFallback(catsScroll);
    attachTouchScrollFallback(rankScroll);

    /**********************************************************************
     * FIRESTORE SYNC
     **********************************************************************/
    roomIdTxt.textContent = ROOM_ID;

    // Paste your Firebase config below:
    const firebaseConfig = {
   apiKey: "AIzaSyA3j74FN_DIrsZclq09lIY62eenSOzP0yQ",
  authDomain: "euphoria-2026.firebaseapp.com",
  projectId: "euphoria-2026",
  storageBucket: "euphoria-2026.firebasestorage.app",
  messagingSenderId: "259023927428",
  appId: "1:259023927428:web:74099e69bea7b07a7b2ad1",
  measurementId: "G-JEVRCV89WB"
};


    const FIREBASE_ENABLED = !!(firebaseConfig && firebaseConfig.projectId);

    function setSyncStatus(kind, text){
      syncTxt.textContent = text;
      syncDot.classList.remove("online","warn","bad");
      if (kind==="online") syncDot.classList.add("online");
      if (kind==="warn") syncDot.classList.add("warn");
      if (kind==="bad") syncDot.classList.add("bad");
    }

    setSyncStatus("bad", FIREBASE_ENABLED ? "connecting‚Ä¶" : "offline");

    let applyingRemote = false;
    let firestoreReady = false;
    let docRef = null;
    let fbInternals = null;

    // Patch localStorage to observe writes
    const _setItem = localStorage.setItem.bind(localStorage);
    const _removeItem = localStorage.removeItem.bind(localStorage);

    localStorage.setItem = function(key, value){
      _setItem(key, value);
      if (String(key).indexOf(LS_PREFIX) === 0) onLocalStorageChanged(key, value);
    };
    localStorage.removeItem = function(key){
      _removeItem(key);
      if (String(key).indexOf(LS_PREFIX) === 0) onLocalStorageChanged(key, null);
    };

    async function initFirebaseSync(){
      if (!FIREBASE_ENABLED){ setSyncStatus("bad","offline"); return; }

      try{
        const appMod = await import("https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js");
        const fsMod = await import("https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js");

        const app = appMod.initializeApp(firebaseConfig);
        const db = fsMod.getFirestore(app);
        docRef = fsMod.doc(db, "neon-awards", ROOM_ID);

        // seed snapshot
        const kv = {};
        const keys = Object.keys(localStorage);
        for (let i=0;i<keys.length;i++){
          if (keys[i].indexOf(LS_PREFIX) === 0) kv[keys[i]] = localStorage.getItem(keys[i]);
        }

        const snap = await fsMod.getDoc(docRef);
        await fsMod.setDoc(docRef, { kv: kv, updatedAt: fsMod.serverTimestamp() }, { merge: true });

        fbInternals = { updateDoc: fsMod.updateDoc, serverTimestamp: fsMod.serverTimestamp };
        firestoreReady = true;
        setSyncStatus("online","synced");

        fsMod.onSnapshot(docRef, function(docSnap){
          const data = docSnap.data() || {};
          const remoteKv = data.kv || {};

          applyingRemote = true;
          try{
            for (const k in remoteKv){
              if (String(k).indexOf(LS_PREFIX) !== 0) continue;
              const v = remoteKv[k];
              const cur = localStorage.getItem(k);
              if (v == null){
                if (cur != null) _removeItem(k);
              }else{
                if (cur !== v) _setItem(k, v);
              }
            }
          } finally {
            applyingRemote = false;
          }

          if (currentProfile){
            renderCategories();
            if (currentCategory) renderRanking();
          }
        });

      }catch(err){
        console.error(err);
        setSyncStatus("bad","sync error");
      }
    }

    function onLocalStorageChanged(key, value){
      if (!FIREBASE_ENABLED || !firestoreReady || applyingRemote || !fbInternals) return;

      const patch = {};
      patch["kv." + key] = value;
      patch["updatedAt"] = fbInternals.serverTimestamp();

      fbInternals.updateDoc(docRef, patch).catch(function(err){
        console.error(err);
        setSyncStatus("warn","retrying‚Ä¶");
      });
    }

    /**********************************************************************
     * UTIL
     **********************************************************************/
    function escapeHtml(s){
      return String(s == null ? "" : s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /**********************************************************************
     * BOOT
     **********************************************************************/
    renderProfiles();
    showHome();
    startIntro();
    initFirebaseSync();
  </script>
</body>
</html>
